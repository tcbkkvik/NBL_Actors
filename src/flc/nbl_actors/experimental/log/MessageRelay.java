/*
 * Copyright (c) 2015 Tor C Bekkvik
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
package flc.nbl_actors.experimental.log;

import flc.nbl_actors.core.*;

import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Consumer;
import java.util.function.Supplier;

/**
 * Standard message relay implementation.
 * Calls to {@link #intercept(Runnable, IGreenThr)}
 * are logged per thread to listener
 * instances, generated by given {@link IMsgListenerFactory}
 * <p>Date 16.01.2015.</p>
 *
 * @author Tor C Bekkvik
 */
public class MessageRelay implements IMessageRelay {

    private static final ThreadLocal<TContext> threadContext
            = ThreadLocal.withInitial(TContext::new);
    private final IMsgListenerFactory listenerFactory;

    /**
     * @param factory Called once per real thread.
     *                Enables parallel event logging.
     *                The generator must return either
     *                (i) a single synchronized listener instance, or
     *                (ii) multiple listeners (data may be merged later).
     */
    public MessageRelay(IMsgListenerFactory factory) {
        listenerFactory = factory;
    }

    /**
     * Add user-defined trace information, via a ThreadLocal context, to message log.
     * Used when {@link IGreenThrFactory#setMessageRelay(IMessageRelay)}
     * is set with an instance of this class ({@link MessageRelay})
     *
     * @param info Info string (may be consumed later)
     */
    public static void setTraceInfo(Supplier<String> info) {
        threadContext.get().setUserInfo(info);
    }

    public static void setTraceInfo(String info) {
        threadContext.get().setUserInfo(() -> info);
    }

    private StackTraceElement stackElement(int lev) {
        final String coreP = "flc.nbl_actors.core";
        int no = 0;
        Throwable ex = new Throwable();
//                ex.printStackTrace();
        StackTraceElement[] trace = ex.getStackTrace();
        for (StackTraceElement se : trace) {
            if (++no >= lev && !se.getClassName().startsWith(coreP)) {
                return se;
            }
        }
        return null;
    }

    private TContext context() {
        TContext c = threadContext.get();
        if (c.listener == null) {
            c.listener = listenerFactory.forkListener();
        }
        return c;
    }

    @Override
    public Runnable intercept(Runnable msg, IGreenThr thread) {
        TContext ctx = context();
//        if (msg instanceof ActorMessage) {
//            ActorMessage actorMsg = (ActorMessage) msg;
//            //todo this is an actor; log extra info? (actor#, greenThr#)
//        }
        final MsgSent sendEvent = new MsgSent(
                ctx.nextId(), ctx.getParentId(), ctx.getUserInfo(), stackElement(3), thread);
        ctx.setUserInfo(null);
        ctx.listener.accept(sendEvent);
        return () -> {
            TContext ctx2 = context();
            ctx2.setParentId(sendEvent.id);
            ctx2.listener.accept(new MsgReceived(sendEvent));
            msg.run();
        };
    }

    /**
     * Thread Context.
     */
    public static class TContext {
        private static AtomicInteger currThrNo = new AtomicInteger();
        private final int thrNo = currThrNo.incrementAndGet();
        private int msgNo; //starts at 1 (0 is undefined)
        private MsgId parentId;
        private Supplier<String> userInfo;
        private Consumer<IMsgEvent> listener;

        private void setParentId(MsgId parentId) {
            this.parentId = parentId;
        }

        public void setUserInfo(Supplier<String> userInfo) {
            this.userInfo = userInfo;
        }

        public MsgId nextId() {
            return new MsgId(thrNo, ++msgNo);
        }

        public MsgId getParentId() {
            return parentId;
        }

        public Supplier<String> getUserInfo() {
            return userInfo;
        }
    }
    //todo unit tests
}
